<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Return Items</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h2>Return Items</h2>
    
    <!-- Input Fields -->
    <div class="form-group">
      <label for="mobileNo">Enter Mobile No:</label>
      <input type="text" id="mobileNo" placeholder="Enter mobile number" required>
    </div>
    <div class="form-group">
      <button id="searchBtn" onclick="searchItems()">Search Items</button>
    </div>

    <!-- Borrowed Items List -->
    <div class="borrowed-items" id="borrowedItemsList">
      <!-- Items will be dynamically populated here -->
    </div>

    <!-- Submit Return Button -->
    <div class="form-group">
      <button class="submit-btn" id="submitReturnBtn" onclick="submitReturn()">Submit Return</button>
    </div>
  </div>

  <script>
    async function searchItems() {
      const mobileNo = document.getElementById("mobileNo").value;

      if (!mobileNo) {
        alert("Please enter a mobile number.");
        return;
      }

      const data = {
        action: "searchItems", // Action for Apps Script
        mobileNo
      };

      try {
        // Replace 'YOUR_WEB_APP_URL' with your Apps Script Web App URL
        const response = await fetch('https://script.google.com/macros/s/AKfycbzEyPfUCNVV5MaOb6Asp87CL4OOztV1iug0p08dKbQuo5nKjeqYYV5nwmrabsaDb5Gvgw/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          populateItems(result.items);
        } else {
          alert("Error: " + result.message);
        }
      } catch (err) {
        alert("Error connecting to the server: " + err.message);
      }
    }

    function populateItems(items) {
      const itemsList = document.getElementById("borrowedItemsList");
      itemsList.innerHTML = ""; // Clear existing items

      if (items.length === 0) {
        itemsList.innerHTML = "<p>No items found for this mobile number.</p>";
        return;
      }

      items.forEach(item => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "item";
        itemDiv.innerHTML = `
          <span>SKU No: ${item.skuNo}</span><br>
          <span>Item Name: ${item.skuName}</span><br>
          <span>Issued Qty: ${item.issuedQty}</span><br>
          <span>Remarks: ${item.remarks || "N/A"}</span><br>
          <label for="returnQty-${item.skuNo}">Return Qty:</label>
          <input type="number" id="returnQty-${item.skuNo}" placeholder="Enter return qty" min="1" max="${item.issuedQty}">
        `;
        itemsList.appendChild(itemDiv);
      });
    }

    async function submitReturn() {
      const mobileNo = document.getElementById("mobileNo").value;

      if (!mobileNo) {
        alert("Please enter a mobile number.");
        return;
      }

      const items = [];
      document.querySelectorAll("[id^='returnQty-']").forEach(input => {
        const skuNo = input.id.replace("returnQty-", "");
        const returnQty = parseInt(input.value, 10);

        if (returnQty) {
          items.push({ skuNo, returnQty });
        }
      });

      if (items.length === 0) {
        alert("Please enter return quantities for at least one item.");
        return;
      }

      const data = {
        action: "processReturn", // Action for Apps Script
        mobileNo,
        items
      };

      try {
        // Replace 'YOUR_WEB_APP_URL' with your Apps Script Web App URL
        const response = await fetch('YOUR_WEB_APP_URL', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          alert("Return processed successfully!");
          document.getElementById("borrowedItemsList").innerHTML = ""; // Clear the list after successful return
        } else {
          alert("Error: " + result.message);
        }
      } catch (err) {
        alert("Error connecting to the server: " + err.message);
      }
    }
  </script>
</body>
</html>
